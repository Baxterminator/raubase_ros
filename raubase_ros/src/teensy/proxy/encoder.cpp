#include "teensy/proxy/encoder.hpp"

#include <rclcpp/logging.hpp>
#include <sstream>

#include "teensy/interface/message.hpp"

namespace raubase::teensy::proxy {

void EncoderProxy::setupParams(rclcpp::Node::SharedPtr node) {
  RCLCPP_INFO(logger, "Initializing proxy %s", NODE_NAME);

  // Declaring parameters for the encoder
  _on = node->declare_parameter("enc_on", true);
  _refresh_rate = node->declare_parameter("enc_ms", DEFAULT_ENC_MS);
  _reverse_enc = node->declare_parameter("enc_rev", true);

  // Initializing working components
  publisher = node->create_publisher<DataEncoder>(PUBLISHING_TOPIC, QOS);
  clock = node->get_clock();
}

void EncoderProxy::setupSubscriptions() {
  if (!_on) return;
  RCLCPP_INFO(logger, "Initializing proxy %s", NODE_NAME);
  subscribeTeensyComponent(TEENSY_COMP, _refresh_rate);
  configEncoderReversing();
}

void EncoderProxy::configEncoderReversing() {
  if (!_on) return;
  std::stringstream ss;
  ss << REVERSED_ENC << " " << ((_reverse_enc) ? "1" : "0");
  sendToTeensy(MSG::make(ss.str().c_str()), false);
}

void EncoderProxy::decode(char* msg) {
  // like: enc 16.2 16.5
  /* enc 1 : motor 1 encoding
   *     2 : motor 2 encoding
   */
  if (strlen(msg) <= 4) return;
  const char* p1 = msg + 4;
  _msg.stamp = clock->now();
  _msg.right = -strtoll(p1, (char**)&p1, 10);
  _msg.left = strtoll(p1, (char**)&p1, 10);

  publisher->publish(_msg);
}

}  // namespace raubase::teensy::proxy